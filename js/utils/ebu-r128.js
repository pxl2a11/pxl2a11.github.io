var EBU_R128=function(){"use strict";const e=new Float32Array([-0.691,10.224,-63.37,175.8,-247.9,187.1]),t=new Float32Array([1.535,2.063,-9.474,12.72,-7.53,1.698]),r=new Float32Array([1.0000000000000004,2,1,1.0000000000000004,2.000000000000001,1.0000000000000004]),s=new Float32Array([-.9999999999999996,-1.9999999999999991,1,-.9999999999999996,-2,-1]),i=192e3;function a(e,t,r,s){this.A=new Float32Array(e),this.B=new Float32Array(t),this.x=new Float32Array(r),this.y=new Float32Array(s)}a.prototype.process=function(e){let t,r,s,i;const a=this.A,o=this.B,n=this.x,h=this.y;for(t=0;t<e.length;t++){for(s=a[0]*e[t],i=0;i<n.length;i++)s+=a[i+1]*n[i]-o[i+1]*h[i];for(i=n.length-1;i>0;i--)n[i]=n[i-1],h[i]=h[i-1];for(n[0]=e[t],h[0]=s,r=0;r<e.length;r++)e[t]=s}};const o=192e3;class n{constructor(e,n){this.samplerate=e,this.channels=n,this.filters=new Array(n);for(let h=0;h<n;h++){let n,l,u,c,d;if(e>o)n=6,l=t,u=s,c=5,d=5;else{n=4,l=e,u=r,c=3,d=3;const t=Math.tan(Math.PI*107.65215/e),a=Math.tan(Math.PI*399.99822/e),p=1+t,f=1-t,g=1+a,w=1-a,y=1/(p*g),m=y*f*w,b=y*p*w,A=y*f*g;l=new Float32Array([1,-b-A,m]),u=new Float32Array([1,b-A,m])}this.filters[h]=new a(l,u,c,d)}}}n.prototype.process=function(e,t){if(void 0===t)this.filters[0].process(e);else for(let r=0;r<this.channels;r++)this.filters[r].process(arguments[r])};const h=.4;class l{constructor(e){this.samplerate=e,this.gate_block_size=Math.round(h*e)}l.prototype.process=function(e,t){const r=e,s=t,i=this.gate_block_size,a=new Float32Array(Math.ceil(r[0].length/i)),o=new Float32Array(s?Math.ceil(s.length/i):0);let n=0;for(let e=0;e<a.length;e++){a[e]=0;let t=n;for(;n<t+i&&n<r[0].length;n++)for(let e=0;e<r.length;e++)a[e]+=r[e][n]*r[e][n];a[e]/=i*r.length}if(s){n=0;for(let e=0;e<o.length;e++){o[e]=0;let t=n;for(;n<t+i&&n<s[0].length;n++)for(let e=0;e<s.length;e++)o[e]+=s[e][n]*s[e][n];o[e]/=i*s.length}}const l=new Array(r.length);for(let e=0;e<l.length;e++)l[e]=new Float32Array(0);let u=new Float32Array(0);let c=0;for(let e=0;e<a.length;e++)if(a[e]>-70)for(let t=0;t<r.length;t++)c+=i;if(c>0){for(let e=0;e<r.length;e++)l[e]=new Float32Array(c);if(s)u=new Float32Array(c);let e=0;for(let t=0;t<a.length;t++){if(a[t]>-70){const a=t*i;for(let o=0;o<i&&a+o<r[0].length;o++){for(let t=0;t<r.length;t++)l[t][e+o]=r[t][a+o];if(s)u[e+o]=s[a+o]}e+=i}}}return{audio:l,gated_loudness:a,gated_loudness_stereo:o}}}const u=-.691;function c(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return 10*Math.log10(t/e.length)+u}function d(e,t,r){let s=0;const i=new Array(e.length);for(let r=0;r<e.length;r++){i[r]=new Float32Array(e[r].length);for(let a=0;a<e[r].length;a++)i[r][a]=e[r][a]}if(t)for(let e=0;e<i[0].length;e++)i[0][e]+=t[e];if(r)for(let e=0;e<i[1].length;e++)i[1][e]+=r[e];const a=new Float32Array(i[0].length);for(let e=0;e<i.length;e++)for(let t=0;t<i[e].length;t++)a[t]+=i[e][t];let o=0;for(let e=0;e<a.length;e++)a[e]>=s&&(s=a[e],o=e);return{max_sample:Math.sqrt(s),sample_pos:o}}class EBU_R128{constructor(e,t){this.samplerate=e,this.c=t||1,this.k=new n(e,t),this.g=new l(e)}process(t,r){const s=this.c;let i,a;if(1===s)a=[new Float32Array(t)];else{const e=new Float32Array(t),s=new Float32Array(r);a=[e,s]}if(this.k.process(a),i=this.g.process(a),this.gated_loudness=c(i.gated_loudness),this.relative_threshold=-10+this.gated_loudness,i.gated_loudness.length>0){const e=i.gated_loudness.filter(e=>e>this.relative_threshold);this.lufs=c(e)}this.true_peak=d(i.audio).max_sample}getIntegratedLoudness(){return this.lufs}}return EBU_R128.prototype.getTruePeak=function(){return 20*Math.log10(this.true_peak)},EBU_R128.prototype.getSamplePeak=function(){return this.true_peak},EBU_R128.prototype.getLUFS=function(){return this.lufs},EBU_R128.prototype.getLoudness=function(){return this.lufs},EBU_R128.prototype.getIntegratedLoudness=function(){return this.lufs},EBU_R128}();
